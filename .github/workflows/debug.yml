---

name: "Debug Workflow Run"
run-name: "Debug Workflow Run"
permissions: read-all

on:
  repository_dispatch:
  workflow_dispatch:
  pull_request:
  push:
    paths: ['.github/workflows/debug.yml']

jobs:

  debug-ipsn-go-libtor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v5
      - run: go mod init example.com/${RANDOM}
      - run: go get -u -v -x github.com/ipsn/go-libtor
      - run: go get -u github.com/cretz/bine/tor
      - run: |
          tee -a main.go << EOF
          package main

          import (
          	"context"
          	"fmt"
          	"log"
          	"net/http"
          	"os"
          	"time"
          
          	"github.com/cretz/bine/tor"
          	"github.com/ipsn/go-libtor"
          )

          func main() {
          	// Start tor with some defaults + elevated verbosity
          	fmt.Println("Starting and registering onion service, please wait a bit...")
          	t, err := tor.Start(nil, &tor.StartConf{ProcessCreator: libtor.Creator, DebugWriter: os.Stderr})
          	if err != nil {
          		log.Panicf("Failed to start tor: %v", err)
          	}
          	defer t.Close()

          	// Wait at most a few minutes to publish the service
          	ctx, cancel := context.WithTimeout(context.Background(), 3*time.Minute)
          	defer cancel()

          	// Create an onion service to listen on any port but show as 80
          	onion, err := t.Listen(ctx, &tor.ListenConf{RemotePorts: []int{80}})
          	if err != nil {
          		log.Panicf("Failed to create onion service: %v", err)
          	}
          	defer onion.Close()

          	fmt.Printf("Please open a Tor capable browser and navigate to http://%v.onion\n", onion.ID)

          	// Run a Hello-World HTTP service until terminated
          	http.HandleFunc("/", func(w http.ResponseWriter, r *http.Request) {
          		fmt.Fprintf(w, "Hello, Tor!")
          	})
          	http.Serve(onion, nil)
          }
          EOF
      - run: go run main.go

  debug-tor:
    runs-on: ubuntu-latest
    steps:
      - run: sudo apt install -y tor
      - run: curl --proxy socks5h://localhost:9050 https://check.torproject.org/api/ip | jq
