---

name: "Debug Workflow Run"
run-name: "Debug Workflow Run"
permissions: read-all

on:
  repository_dispatch:
  workflow_dispatch:
  pull_request:
  push:
    paths: ['.github/workflows/debug.yml']

jobs:

  debug-ipsn-go-libtor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v5
      - run: sudo apt install -y tor
      - run: go mod init example.com/${RANDOM}
      - run: go get -u -v -x github.com/ipsn/go-libtor
      - run: go get -u github.com/cretz/bine/tor
      - run: |
          tee -a main.go << EOF
          package main

          import (
          	"context"
          	"fmt"
          	"log"
          	"net/http"
          	"time"

          	"github.com/cretz/bine/tor"
          )

          func main() {
          	// Start tor with default config (can set start conf's DebugWriter to os.Stdout for debug logs)
          	fmt.Println("Starting and registering onion service, please wait a couple of minutes...")
          	t, err := tor.Start(nil, nil)
          	if err != nil {
          		log.Panicf("Unable to start Tor: %v", err)
          	}
          	defer t.Close()
          	// Wait at most a few minutes to publish the service
          	listenCtx, listenCancel := context.WithTimeout(context.Background(), 3*time.Minute)
          	defer listenCancel()
          	// Create a v3 onion service to listen on any port but show as 80
          	onion, err := t.Listen(listenCtx, &tor.ListenConf{RemotePorts: []int{80}})
          	if err != nil {
          		log.Panicf("Unable to create onion service: %v", err)
          	}
          	defer onion.Close()
          	fmt.Printf("Open Tor browser and navigate to http://%v.onion\n", onion.ID)
          	fmt.Println("Press enter to exit")
          	// Serve the current folder from HTTP
          	errCh := make(chan error, 1)
          	go func() { errCh <- http.Serve(onion, http.FileServer(http.Dir("."))) }()
          	// End when enter is pressed
          	go func() {
          		fmt.Scanln()
          		errCh <- nil
          	}()
          	if err = <-errCh; err != nil {
          		log.Panicf("Failed serving: %v", err)
          	}
          }
          EOF
      - run: go run main.go

  debug-tor:
    runs-on: ubuntu-latest
    steps:
      - run: sudo apt install -y tor
      - run: curl --proxy socks5h://localhost:9050 https://check.torproject.org/api/ip | jq
